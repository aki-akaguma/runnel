**Design Document: `runnel` Library**

This document outlines the design of the `runnel` library, based on the acceptance criteria and the existing source code.

**1. Core Design**

The `runnel` library is designed around the concept of **pluggable I/O streams**. This is achieved through a set of traits that define the contracts for input, output, and error streams:

*   **`StreamIn`:** Represents an input stream. It requires the `Send`, `Sync`, `UnwindSafe`, `RefUnwindSafe`, and `Debug` traits. It has a single method, `lock()`, which returns a locked reference to the stream.
*   **`StreamOut`:** Represents an output stream. It also requires the `Send`, `Sync`, `UnwindSafe`, `RefUnwindSafe`, and `Debug` traits. It has a single method, `lock()`, which returns a locked reference to the stream.
*   **`StreamErr`:** Represents an error stream. It has the same requirements and `lock()` method as `StreamOut`.

The use of `Box<dyn Trait>` allows for dynamic dispatch, enabling the library to work with different stream implementations at runtime.

**2. Key Data Structures**

*   **`RunnelIoe`:** This struct is the primary entry point for using the library. It holds the three I/O streams (`pin`, `pout`, `perr`) as `Box<dyn StreamIn>`, `Box<dyn StreamOut>`, and `Box<dyn StreamErr>`, respectively.
*   **`RunnelIoeBuilder`:** This builder struct provides a convenient way to construct a `RunnelIoe` instance. It allows for the configuration of each stream individually, with `stdio` as the default if no other stream is specified.

**3. Stream Implementations**

The `runnel` library provides several stream implementations in the `medium` module:

*   **`stdio`:** This is the default implementation. It wraps the standard I/O streams from the Rust standard library (`std::io::stdin`, `std::io::stdout`, `std::io::stderr`).
*   **`stringio`:** This implementation provides in-memory string-based streams. `StringIn` is used for input, and `StringOut` and `StringErr` are used for output and error, respectively. This is particularly useful for testing, as it allows for the simulation of I/O without interacting with the console.
*   **`pipeio`:** This implementation provides in-memory pipes for inter-thread communication. The `pipe()` function creates a `PipeOut` and a `PipeIn` that are connected. This allows for building concurrent applications where different threads can communicate with each other.
*   **`lineio`:** This implementation is currently a placeholder and is intended to provide line-buffered I/O in the future.

**4. Locking and Concurrency**

The `lock()` method on each stream trait returns a locked reference to the underlying stream. This is essential for ensuring thread safety when using the streams in a concurrent environment. The use of `Mutex` in the `stringio` and `pipeio` implementations ensures that only one thread can access the stream at a time.

**5. API Design**

The API is designed to be minimal and easy to use. The `RunnelIoeBuilder` provides a fluent interface for configuring the streams, and the `RunnelIoe` struct provides simple access to the `pin`, `pout`, and `perr` streams. The `lock()` method is the primary way to interact with the streams, and it returns a locked reference that implements the standard `Read`, `Write`, and `BufRead` traits.
